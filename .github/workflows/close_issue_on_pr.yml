name: Close Issue on PR Action
on:
  pull_request:
    types: [closed]

jobs:
  cleanup_issue:
    # This ensures it only runs for PRs created by your other workflow
    if: startsWith(github.event.pull_request.head.ref, 'entry-')
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: read
      contents: read
    steps:
      - name: Extract Issue Number
        id: info
        run: |
          # Extract number from branch 'entry-123'
          BRANCH="${{ github.event.pull_request.head.ref }}"
          ISSUE_NUM=$(echo $BRANCH | sed 's/entry-//')
          echo "num=$ISSUE_NUM" >> $GITHUB_OUTPUT

      - name: Handle Merged Entry
        if: github.event.pull_request.merged == true
        run: |
          gh issue comment ${{ steps.info.outputs.num }} --body "✅ **Entry Completed!** The resource has been added to the database."
          gh issue edit ${{ steps.info.outputs.num }} --title "[Completed]: ${{ github.event.pull_request.title }}"
          gh issue close ${{ steps.info.outputs.num }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Handle Rejected Entry
        if: github.event.pull_request.merged == false
        run: |
          gh issue comment ${{ steps.info.outputs.num }} --body "❌ **Entry Not Added.** This request was closed without merging."
          gh issue edit ${{ steps.info.outputs.num }} --title "[Rejected]: ${{ github.event.pull_request.title }}"
          gh issue close ${{ steps.info.outputs.num }} --reason "not planned"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
