name: Monthly CSV â†’ Markdown table

on:
  schedule:
    # 07:00 UTC on the 1st of every month (â‰ˆ 08:00/09:00 Europe/Prague depending on DST)
    - cron: "0 7 1 * *"
  workflow_dispatch: {}  # lets you run it manually

permissions:
  contents: write  # allow committing back to the repo

jobs:
  build-table:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      # (Optional) Quick visibility/debug. You can delete later.
      - name: Show repo layout
        run: |
          pwd
          ls -la
          echo "---- data ----"; ls -la data || true
          echo "---- output ----"; ls -la | sed -n '1,200p'

      - name: Build resources-table.md from CSV (inline Python)
        run: |
          python - <<'PY'
          import csv
          from pathlib import Path

          CSV_PATH = Path("data/data.csv")          # <-- change if your CSV lives elsewhere
          OUT = Path("resources-table.md")
          START = "<!-- AUTO-TABLE:START -->"
          END   = "<!-- AUTO-TABLE:END -->"

          # Ensure output file & markers exist
          if not OUT.exists():
              OUT.write_text("# ðŸ“Š Resources Table\n\n" + START + "\n" + END + "\n", encoding="utf-8")
          text = OUT.read_text(encoding="utf-8")
          if START not in text or END not in text:
              raise SystemExit("Markers not found in resources-table.md")

          # Read CSV (auto-detect common delimiters)
          if not CSV_PATH.exists():
              raise SystemExit(f"CSV not found: {CSV_PATH.resolve()}")
          with CSV_PATH.open("r", encoding="utf-8", newline="") as f:
              sample = f.read(4096); f.seek(0)
              try:
                  dialect = csv.Sniffer().sniff(sample, delimiters=[",",";","\t","|"])
              except csv.Error:
                  dialect = csv.excel
              rows = list(csv.reader(f, dialect))

          # Build Markdown table
          if not rows:
              table = "_No data_"
          else:
              headers, data = rows[0], rows[1:]
              lines = []
              lines.append("|" + "|".join(h or " " for h in headers) + "|")
              lines.append("|" + "|".join("---" for _ in headers) + "|")
              if data:
                  for r in data:
                      lines.append("|" + "|".join((c or " ").replace("\n"," ") for c in r) + "|")
              else:
                  lines.append("|" + "|".join(" " for _ in headers) + "|")
              table = "\n".join(lines)

          # Replace between markers
          pre, rest = text.split(START, 1)
          _, post = rest.split(END, 1)
          updated = f"{pre}{START}\n\n{table}\n\n{END}{post}"

          if updated != text:
              OUT.write_text(updated, encoding="utf-8")
              print("Updated resources-table.md")
          else:
              print("No change to resources-table.md")
          PY

      - name: Commit and push if changed
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add -A
            git commit -m "Auto-update resources-table from CSV ($(date -u +%F))"
            git push
          else
            echo "No changes to commit."
          fi
