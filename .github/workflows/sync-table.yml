name: Monthly CSV â†’ Markdown table

on:
  schedule:
    # 07:00 UTC on the 1st of every month (â‰ˆ 08:00/09:00 Europe/Prague depending on DST)
    - cron: "0 7 1 * *"
  workflow_dispatch: {}  # lets you run it manually

permissions:
  contents: write  # allow committing back to the repo

jobs:
  build-table:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      # (Optional) Quick visibility/debug. Safer version (no sed).
      - name: Show repo layout
        run: |
          pwd
          ls -la
          echo "---- data ----"
          ls -la data || true
          echo "---- output ----"
          ls -la | head -n 200

      - name: Build resources-table.md from CSV (inline Python)
        run: |
          python3 - <<'PY'
          import csv, unicodedata, re
          from pathlib import Path
          from urllib.parse import quote

          CSV_PATH = Path("data/data.csv")
          OUT = Path("resources-table.md")
          START = "<!-- AUTO-TABLE:START -->"
          END   = "<!-- AUTO-TABLE:END -->"

          # Columns where we want "Yes" â†’ header name, "No" â†’ blank
          TARGET_HEADERS_CANONICAL = [
              "DataSteward Training",
              "open science",
              "data",
              "database",
              "repositories",
              "licensing",
          ]

          # Robust normalization (handles BOM, NBSP, unicode, extra spaces)
          def norm(s: str) -> str:
              if s is None:
                  return ""
              s = unicodedata.normalize("NFKC", s)
              s = s.replace("\u00A0", " ")  # NBSP â†’ space
              s = s.strip()
              s = re.sub(r"\s+", " ", s)   # collapse runs of whitespace
              return s

          YES_VALUES = {"yes", "y", "true", "1", "âœ“", "âœ”", "x"}
          NO_VALUES  = {"no", "n", "false", "0", "âœ—", "Ã—"}

          # Map lowercase normalized header â†’ canonical display text
          TARGET_HEADERS = { norm(h).lower(): h for h in TARGET_HEADERS_CANONICAL }

          COLOR_MAP = {
              "Categories": {
                  "webpage": "#8250df",
                  "article": "#0969da",
                  "practical guides": "#f97316",
                  "document": "#ec4899",
                  "course": "#22c55e",
                  "video": "#eab308",
                  "meeting": "#8B0000",
              },
          }

          def badge(text: str, color: str) -> str:
              t = quote(text.replace("-", "â€“"))
              c = color.lstrip("#")
              return f"![{text}](https://img.shields.io/badge/{t}-{c}?style=flat)"

          def render_cell(value: str, header: str) -> str:
              hv = norm(header)
              vv_raw = value if value is not None else ""
              vv = norm(vv_raw)

              if not vv:
                  return " "

              h_key = hv.lower()

              # Replace Yes/No only in target columns
              if h_key in TARGET_HEADERS:
                  vkey = vv.lower()
                  if vkey in YES_VALUES:
                      return TARGET_HEADERS[h_key]   # show the column title
                  if vkey in NO_VALUES:
                      return " "                    # blank for No
                  # fallthrough: if it's something else, keep as-is (but normalized)
                  return vv

              # Otherwise, apply optional badge coloring
              if hv in COLOR_MAP:
                  cmap = COLOR_MAP[hv]
                  vkey = vv.lower()
                  if vkey in cmap:
                      return badge(vv, cmap[vkey])

              return vv

          # Ensure output file & markers exist
          if not OUT.exists():
              OUT.write_text("# ðŸ“Š Resources Table\n\n" + START + "\n" + END + "\n", encoding="utf-8")
          text = OUT.read_text(encoding="utf-8")
          if START not in text or END not in text:
              raise SystemExit("Markers not found in resources-table.md")

          # Read CSV (utf-8-sig removes BOM)
          if not CSV_PATH.exists():
              raise SystemExit(f"CSV not found: {CSV_PATH.resolve()}")
          with CSV_PATH.open("r", encoding="utf-8-sig", newline="") as f:
              sample = f.read(4096)
              f.seek(0)
              try:
                  dialect = csv.Sniffer().sniff(sample, delimiters=[",",";","\t","|"])
              except csv.Error:
                  dialect = csv.excel
              rows = list(csv.reader(f, dialect))

          # Build Markdown table
          per_row_summary_md = ""

          if not rows:
              table = "_No data_"
          else:
              # Trim trailing empty columns
              def last_non_empty_idx(r):
                  for k in range(len(r) - 1, -1, -1):
                      if norm(r[k]):
                          return k
                  return -1
              rightmost = max(last_non_empty_idx(r) for r in rows)
              if rightmost == -1:
                  table = "_No data_"
              else:
                  rows = [r[: rightmost + 1] for r in rows]

                  max_cols = max(len(r) for r in rows)
                  def mkrow(cells):
                      return "|" + "|".join((c if norm(c) else " ") for c in cells) + "|"

                  # Headers (raw â†’ canonical for matching; displayed as-is but bold)
                  raw_headers = rows[0] + [""] * (max_cols - len(rows[0]))
                  headers_row = [norm(h) for h in raw_headers]  # normalized for matching/mapping

                  lines = []

                  # ---- Header row (display; not transformed) ----
                  hdr_cells = [
                      (rows[0][j] if j < len(rows[0]) else "").replace("\n", "<br>")
                      for j in range(max_cols)
                  ]
                  hdr_cells = [f"**{c}**" if norm(c) else c for c in hdr_cells]
                  lines.append(mkrow(hdr_cells))

                  # ---- Markdown header separator ----
                  lines.append("|" + "|".join("---" for _ in range(max_cols)) + "|")

                  # ---- Row 2 (bold) ----
                  if len(rows) > 1:
                      r = rows[1]
                      padded = r + [""] * (max_cols - len(r))
                      cells = [
                          render_cell(padded[j].replace("\n", "<br>"),
                                      headers_row[j] if j < len(headers_row) else "")
                          for j in range(max_cols)
                      ]
                      cells = [f"**{c}**" if norm(c) else c for c in cells]
                      lines.append(mkrow(cells))

                  # ---- Remaining rows ----
                  for r in rows[2:]:
                      padded = r + [""] * (max_cols - len(r))
                      cells = [
                          render_cell(padded[j].replace("\n", "<br>"),
                                      headers_row[j] if j < len(headers_row) else "")
                          for j in range(max_cols)
                      ]
                      lines.append(mkrow(cells))

                  table = "\n".join(lines)

                  # ---------- Compact per-row summary ----------
                  header_index = { norm(headers_row[i]).lower(): i for i in range(len(headers_row)) }
                  if any(h in header_index for h in TARGET_HEADERS):
                      summary = [
                          "",
                          "#### Per-row selected topics",
                          "",
                          "| Row | Columns with â€œYesâ€ |",
                          "|-----|---------------------|",
                      ]
                      for ridx, r in enumerate(rows[1:], start=1):
                          padded = r + [""] * (max_cols - len(r))
                          yes_labels = []
                          for h_lc, h_canonical in TARGET_HEADERS.items():
                              j = header_index.get(h_lc)
                              if j is None:
                                  continue
                              v = norm(padded[j]).lower()
                              if v in YES_VALUES:
                                  yes_labels.append(h_canonical)
                          summary.append(f"| {ridx} | {', '.join(yes_labels) if yes_labels else 'â€”'} |")
                      per_row_summary_md = "\n".join(summary)

          # Replace between markers
          pre, rest = text.split(START, 1)
          _, post = rest.split(END, 1)
          updated = f"{pre}{START}\n\n{table}{per_row_summary_md}\n\n{END}{post}"

          if updated != text:
              OUT.write_text(updated, encoding="utf-8")
              print("âœ… Updated resources-table.md (Yesâ†’header, per-row summary, BOM-safe)")
          else:
              print("No changes to resources-table.md")
          PY

      - name: Commit and push if changed
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add -A
            git commit -m "Auto-update resources-table from CSV ($(date -u +%F))"
            git push
          else
            echo "No changes to commit."
          fi
