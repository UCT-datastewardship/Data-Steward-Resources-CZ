name: Monthly CSV â†’ Markdown table

on:
  schedule:
    # 07:00 UTC on the 1st of every month (â‰ˆ 08:00/09:00 Europe/Prague depending on DST)
    - cron: "0 7 1 * *"
  workflow_dispatch: {}  # lets you run it manually

permissions:
  contents: write  # allow committing back to the repo

jobs:
  build-table:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      # (Optional) Quick visibility/debug. Safer version (no sed).
      - name: Show repo layout
        run: |
          pwd
          ls -la
          echo "---- data ----"
          ls -la data || true
          echo "---- output ----"
          ls -la | head -n 200

      - name: Build resources-table.md from CSV (inline Python)
        run: |
          python3 - <<'PY'
          import csv
          from pathlib import Path
          from urllib.parse import quote

          CSV_PATH = Path("data/data.csv")
          OUT = Path("resources-table.md")
          START = "<!-- AUTO-TABLE:START -->"
          END   = "<!-- AUTO-TABLE:END -->"

          # Columns where we want "Yes" â†’ header name, "No" â†’ blank
          TARGET_HEADERS = {
              h.lower(): h  # map lowercase â†’ canonical header text
              for h in [
                  "DataSteward Training",
                  "open science",
                  "data",
                  "database",
                  "repositories",
                  "licensing",
              ]
          }

          COLOR_MAP = {
              "Categories": {
                  "webpage": "#8250df",
                  "article": "#0969da",
                  "practical guides": "#f97316",
                  "document": "#ec4899",
                  "course": "#22c55e",
                  "video": "#eab308",
                  "meeting": "#8B0000",
              },
          }

          def badge(text: str, color: str) -> str:
              t = quote(text.replace("-", "â€“"))
              c = color.lstrip("#")
              return f"![{text}](https://img.shields.io/badge/{t}-{c}?style=flat)"

          def render_cell(value: str, header: str) -> str:
              """Render a single cell, with special handling for TARGET_HEADERS."""
              if value is None:
                  return " "
              v = value.strip()
              if not v:
                  return " "

              h_key_raw = (header or "").strip()
              h_key = h_key_raw.lower()

              # If this column is one of the six target headers:
              if h_key in TARGET_HEADERS:
                  if v.lower() == "yes":
                      # Show the column title instead of "Yes"
                      return TARGET_HEADERS[h_key]
                  if v.lower() == "no":
                      # Show blank instead of "No"
                      return " "

              # Otherwise, fall back to badges/color mapping if configured
              v_key = v.lower()
              if h_key_raw in COLOR_MAP:
                  cmap = COLOR_MAP[h_key_raw]
                  if v_key in cmap:
                      return badge(v, cmap[v_key])
              return v

          # Ensure output file & markers exist
          if not OUT.exists():
              OUT.write_text("# ðŸ“Š Resources Table\n\n" + START + "\n" + END + "\n", encoding="utf-8")
          text = OUT.read_text(encoding="utf-8")
          if START not in text or END not in text:
              raise SystemExit("Markers not found in resources-table.md")

          # Read CSV (utf-8-sig removes BOM like 'ï»¿Title')
          if not CSV_PATH.exists():
              raise SystemExit(f"CSV not found: {CSV_PATH.resolve()}")
          with CSV_PATH.open("r", encoding="utf-8-sig", newline="") as f:
              sample = f.read(4096)
              f.seek(0)
              try:
                  dialect = csv.Sniffer().sniff(sample, delimiters=[",",";","\t","|"])
              except csv.Error:
                  dialect = csv.excel
              rows = list(csv.reader(f, dialect))

          # Build Markdown table with proper header separator
          per_row_summary_md = ""  # will append a per-row "Yes â†’ headers" summary table

          if not rows:
              table = "_No data_"
          else:
              # Optional: trim trailing empty columns across all rows
              def last_non_empty_idx(r):
                  for k in range(len(r) - 1, -1, -1):
                      if (r[k] or "").strip():
                          return k
                  return -1
              rightmost = max(last_non_empty_idx(r) for r in rows)
              if rightmost == -1:
                  table = "_No data_"
              else:
                  rows = [r[: rightmost + 1] for r in rows]

                  max_cols = max(len(r) for r in rows)
                  def mkrow(cells):
                      return "|" + "|".join((c if c.strip() else " ") for c in cells) + "|"

                  # Use row 0 as headers for mapping of later rows
                  headers_row = rows[0] + [""] * (max_cols - len(rows[0]))

                  lines = []

                  # ---- Header (row 0) ----
                  hdr_cells = [
                      render_cell((rows[0][j] if j < len(rows[0]) else "").replace("\n", "<br>"),
                                  headers_row[j] if j < len(headers_row) else "")
                      for j in range(max_cols)
                  ]
                  # Bold header row
                  hdr_cells = [f"**{c}**" if c.strip() else c for c in hdr_cells]
                  lines.append(mkrow(hdr_cells))

                  # ---- Mandatory Markdown header separator ----
                  lines.append("|" + "|".join("---" for _ in range(max_cols)) + "|")

                  # ---- Row 1 (second CSV row) â€“ bold as requested ----
                  if len(rows) > 1:
                      r = rows[1]
                      padded = r + [""] * (max_cols - len(r))
                      cells = [
                          render_cell(padded[j].replace("\n", "<br>"),
                                      headers_row[j] if j < len(headers_row) else "")
                          for j in range(max_cols)
                      ]
                      cells = [f"**{c}**" if c.strip() else c for c in cells]
                      lines.append(mkrow(cells))

                  # ---- Remaining data rows ----
                  for r in rows[2:]:
                      padded = r + [""] * (max_cols - len(r))
                      cells = [
                          render_cell(padded[j].replace("\n", "<br>"),
                                      headers_row[j] if j < len(headers_row) else "")
                          for j in range(max_cols)
                      ]
                      lines.append(mkrow(cells))

                  table = "\n".join(lines)

                  # ---------- Per-row compact summary (e.g., "DataSteward Training, data, licensing") ----------
                  # Find indices of the six target columns in the header
                  header_index = { (headers_row[i] or "").strip().lower(): i for i in range(len(headers_row)) }
                  target_indices = [header_index[h] for h in TARGET_HEADERS.keys() if h in header_index]

                  if target_indices:
                      # Build a 2-column Markdown table: Row | Columns with "Yes"
                      summary_lines = [
                          "",
                          "#### Per-row selected topics",
                          "",
                          "| Row | Columns with â€œYesâ€ |",
                          "|-----|---------------------|",
                      ]
                      # Iterate data rows (starting from row index 1)
                      for ridx, r in enumerate(rows[1:], start=1):
                          padded = r + [""] * (max_cols - len(r))
                          yes_labels = []
                          for h_lc, h_canonical in TARGET_HEADERS.items():
                              if h_lc in header_index:
                                  j = header_index[h_lc]
                                  v = (padded[j] or "").strip().lower()
                                  if v == "yes":
                                      yes_labels.append(h_canonical)
                          summary_lines.append(f"| {ridx} | {' , '.join(yes_labels) if yes_labels else 'â€”'} |")
                      per_row_summary_md = "\n".join(summary_lines)

          # Replace between markers
          pre, rest = text.split(START, 1)
          _, post = rest.split(END, 1)
          updated = f"{pre}{START}\n\n{table}{per_row_summary_md}\n\n{END}{post}"

          if updated != text:
              OUT.write_text(updated, encoding="utf-8")
              print("âœ… Updated resources-table.md (Yesâ†’header, per-row summary, BOM-safe)")
          else:
              print("No changes to resources-table.md")
          PY

      - name: Commit and push if changed
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add -A
            git commit -m "Auto-update resources-table from CSV ($(date -u +%F))"
            git push
          else
            echo "No changes to commit."
          fi
