name: Append Entry to CSV
on:
  issues:
    types: [opened]

jobs:
  add_row:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Parse Issue Form
        id: parse
        uses: stefanbuck/github-issue-parser@v3

      - name: Process and Append
        shell: python
        run: |
          """
          LICENSE: MIT
          ATTRIBUTION: Scripts were created using Google Gemini, Perplexity and ChatGPT.
          """
          import csv
          import json
          import os

          # 1. Load the data
          issue_data = json.loads('''${{ steps.parse.outputs.jsonString }}''')
          file_path = 'data/data.csv'

          # 2. Extract values
          title = issue_data.get("title", "").replace(",", ";")
          link = issue_data.get("link", "").replace(",", ";")
          know = issue_data.get("knowledge", "")
          time = issue_data.get("time", "")
          langs = issue_data.get("language", []) # List from checkboxes
          cats = issue_data.get("categories", [])
          info = issue_data.get("information", "").replace(",", ";")
          keys = issue_data.get("keywords", [])

          if not title or title == "null":
              print("Error: Title is empty")
              exit(1)

          # 3. Read existing headers to ensure alignment
          with open(file_path, mode='r', encoding='utf-8') as f:
              reader = csv.reader(f)
              header1 = next(reader)
              header2 = next(reader)

          # 4. Create blank row of correct length (35 columns)
          new_row = [""] * len(header1)
          
          # Mapping data to specific column indices
          new_row[0] = title
          new_row[1] = link
          
          # Categories mapping (columns 4, 5, 6, 7)
          if "webpage" in cats: new_row[4] = "webpage"
          if "course" in cats: new_row[5] = "course"
          if "video" in cats: new_row[6] = "video"
          if "article" in cats: new_row[7] = "article"

          # Knowledge Level (Column 10)
          new_row[10] = know

          # Time needed (Column 13)
          new_row[13] = time

          # Language mapping (Fills Column 16 and 17 if two are selected)
          for i, l in enumerate(langs[:2]):
              new_row[16+i] = l

          # Keyword mapping (starts at column 19)
          keyword_list = ["Data Steward Training", "open science", "data", "database", "repositories", 
                          "licensing", "good practices", "bad practices", "RDM", "DMP", 
                          "FAIR", "HE", "GAÄŒR", "other"]
          
          for i, kw in enumerate(keyword_list):
              if kw in keys:
                  new_row[19+i] = "Yes"

          # Information (Last column)
          new_row[-1] = info

          # 5. Append the row
          with open(file_path, mode='a', encoding='utf-8', newline='') as f:
              writer = csv.writer(f)
              writer.writerow(new_row)
          
          with open(os.environ['GITHUB_ENV'], 'a') as env:
              env.write(f"FINAL_TITLE={title}\n")

      - name: Commit and Push
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add data/data.csv
          git commit -m "Add entry: $FINAL_TITLE"
          git push

      - name: Rename and Close Issue
        run: |
          gh issue edit ${{ github.event.issue.number }} --title "[Data Entry]: $FINAL_TITLE"
          gh issue close ${{ github.event.issue.number }} --comment "Added successfully."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
