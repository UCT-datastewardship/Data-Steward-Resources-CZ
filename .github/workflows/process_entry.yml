name: Append Entry to CSV
on:
  issues:
    types: [opened]

jobs:
  add_row:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Parse Issue Form
        id: parse
        uses: stefanbuck/github-issue-parser@v3

      - name: Process and Append
        shell: python
        run: |
          import csv
          import json
          import os

          # 1. Load the parsed data
          issue_data = json.loads('''${{ steps.parse.outputs.jsonString }}''')
          file_path = 'data/data.csv'

          # 2. Extract values (cleaning commas to avoid breaking CSV)
          def get_val(key):
              val = issue_data.get(key, "")
              return val.replace(",", ";") if isinstance(val, str) else val

          title = get_val("Title")
          link = get_val("Link to source")
          know = get_val("Knowledge level")
          time = get_val("Time needed")
          lang = get_val("Language")
          info = get_val("Information")
          cats = issue_data.get("Categories", [])
          keys = issue_data.get("Keywords", [])

          # 3. Read existing headers to match alignment
          with open(file_path, mode='r', encoding='utf-8') as f:
              reader = csv.reader(f)
              headers = next(reader) # Row 1
              sub_headers = next(reader) # Row 2

          # 4. Build the new row based on header names
          new_row = [""] * len(headers)
          
          for i, header in enumerate(headers):
              h_lower = header.lower()
              s_lower = sub_headers[i].lower() if i < len(sub_headers) else ""

              if "title" in h_lower: new_row[i] = title
              elif "link" in h_lower: new_row[i] = link
              elif "knowledge" in h_lower: new_row[i] = know
              elif "time" in h_lower: new_row[i] = time
              elif "language" in h_lower: new_row[i] = lang
              elif "information" in h_lower: new_row[i] = info
              
              # Place Categories
              if "categories" in h_lower:
                  for cat in cats:
                      if cat.lower() in s_lower or cat.lower() in h_lower:
                          new_row[i] = cat

              # Place Keywords (Yes/No)
              for key in keys:
                  if key.lower() in s_lower:
                      new_row[i] = "Yes"

          # 5. Append the row
          with open(file_path, mode='a', encoding='utf-8', newline='') as f:
              writer = csv.writer(f)
              writer.writerow(new_row)
          
          # Pass title to env for renaming
          with open(os.environ['GITHUB_ENV'], 'a') as env:
              env.write(f"FINAL_TITLE={title}\n")

      - name: Commit and Push
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add data/data.csv
          git commit -m "Automated entry: $FINAL_TITLE"
          git push

      - name: Rename and Close Issue
        run: |
          gh issue edit ${{ github.event.issue.number }} --title "[Data Entry]: $FINAL_TITLE"
          gh issue close ${{ github.event.issue.number }} --comment "Added successfully to CSV."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
