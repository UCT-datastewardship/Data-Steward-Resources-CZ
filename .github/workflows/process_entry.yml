#this script takes information added in the ISSUE FORM for new data entry, and adds the entry to the data.csv
name: Append Entry to CSV
on:
  issues:
    types: [opened]

jobs:
  add_row:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write # Required to create PRs
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Parse Issue Form
        id: parse
        uses: stefanbuck/github-issue-parser@v3

      - name: Process and Append
        shell: python
        run: |
          import csv
          import json
          import os

          # 1. Load the data
          issue_data = json.loads('''${{ steps.parse.outputs.jsonString }}''')
          file_path = 'data/data.csv'

          # 2. Extract values
          title = issue_data.get("title", "").strip()
          link = issue_data.get("link", "").strip()
          cats = issue_data.get("categories", [])
          knows = issue_data.get("knowledge_level", [])
          duration = issue_data.get("duration_choice", "")
          pace_list = issue_data.get("self_paced_choice", [])
          langs = issue_data.get("language_choice", [])
          keys = issue_data.get("keywords", [])
          info = issue_data.get("information", "").strip().replace(",", ";")

          if not title or title.lower() == "null":
              exit(1)

          # 3. Create blank row (35 columns)
          new_row = [""] * 35
          
          new_row[0] = title
          new_row[1] = link
          
          # Categories: Indices 2-8
          for i, val in enumerate(cats[:7]):
              new_row[2+i] = val

          # Knowledge Level: Indices 9-12
          for i, val in enumerate(knows[:4]):
              new_row[9+i] = val

          # Time Needed: Index 13 (Duration) and Index 14 (Self-paced)
          new_row[13] = duration
          if pace_list and "self-paced" in str(pace_list).lower():
              new_row[14] = "self-paced"

          # Language: Indices 15-18
          for i, val in enumerate(langs[:4]):
              new_row[15+i] = val

          # Keywords: Starts at index 19
          keyword_list = ["Data Steward Training", "open science", "data", "database", "repositories", 
                          "licensing", "good practices", "bad practices", "RDM", "DMP", 
                          "FAIR", "HE", "GAÄŒR", "other"]
          
          for i, kw in enumerate(keyword_list):
              if kw in keys:
                  new_row[19+i] = "Yes"

          new_row[34] = info

          # 4. Append
          with open(file_path, mode='a', encoding='utf-8', newline='') as f:
              writer = csv.writer(f)
              writer.writerow(new_row)
          
          with open(os.environ['GITHUB_ENV'], 'a') as env:
              env.write(f"FINAL_TITLE={title}\n")

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Add entry: ${{ env.FINAL_TITLE }}"
          title: "Verify Entry: ${{ env.FINAL_TITLE }}"
          body: |
            New data entry submitted via Issue #${{ github.event.issue.number }}.
            Please review the CSV changes below before merging.
          branch: "entry-${{ github.event.issue.number }}"
          delete-branch: true

      - name: Update and Comment on Issue
        run: |
          gh issue edit ${{ github.event.issue.number }} --title "[Reviewing]: $FINAL_TITLE"
          gh issue comment ${{ github.event.issue.number }} --body "A Pull Request has been created for your entry. It will be added to the database once reviewed by an admin."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
